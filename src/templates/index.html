<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RSS Feed Reader</title>
    <link href="https://unpkg.com/@primer/css@^20.2.4/dist/primer.css" rel="stylesheet" />
    <style>
    .Counter {
        background-color: var(--color-counter-bg);
        color: var(--color-counter-fg);
        font-size: 12px;
        padding: 2px 6px;
        border-radius: 20px;
    }
    </style>
</head>
<body>
    <!-- New header section -->
    <header class="Header">
        <div class="Header-item">
            <h1 class="Header-link f4 d-flex flex-items-center">
                <svg height="32" class="octicon octicon-rss mr-2" viewBox="0 0 16 16" version="1.1" width="32" aria-hidden="true">
                    <path fill="currentColor" d="M2.002 2.725a.75.75 0 0 1 .797-.699C8.79 2.42 13.58 7.21 13.974 13.201a.75.75 0 1 1-1.497.098 10.502 10.502 0 0 0-9.776-9.776.75.75 0 0 1-.699-.798ZM2 13a1 1 0 1 1 2 0 1 1 0 0 1-2 0Zm.84-5.95a.75.75 0 0 0-.179 1.489c2.509.3 4.5 2.291 4.8 4.8a.75.75 0 1 0 1.49-.178A7.003 7.003 0 0 0 2.838 7.05Z"></path>
                </svg>
                <span>RSS Feed Reader</span>
            </h1>
        </div>
        <div class="Header-item Header-item--full"></div>
        <div class="Header-item mr-0">
            <nav class="d-flex flex-items-center">
                <a class="Header-link mr-3" href="/">Home</a>
                <a class="Header-link" href="/about">About</a>
            </nav>
        </div>
    </header>

    <div class="Layout">
        <!-- Left sidebar -->
        <div class="Layout-sidebar">
            <nav class="menu" aria-label="Category">
                <a class="menu-item d-flex flex-items-center {% if not selected_category %}selected{% endif %}" href="/">
                    <span class="flex-auto">All Categories</span>
                    {% if total_unread > 0 %}
                    <span class="Counter">{{ total_unread }}</span>
                    {% endif %}
                </a>
                {% for category in categories %}
                <a class="menu-item d-flex flex-items-center {% if category == selected_category %}selected{% endif %}" 
                   href="/?category={{ category }}">
                    <span class="flex-auto">{{ category }}</span>
                    {% if category_counts.get(category, 0) > 0 %}
                    <span class="Counter">{{ category_counts.get(category, 0) }}</span>
                    {% endif %}
                </a>
                {% endfor %}
            </nav>
        </div>

        <!-- Main content -->
        <div class="Layout-main">
            <div class="container-lg clearfix">
                <div class="Box">
                    {% for feed in feeds %}
                    <div class="Box-row {% if feed.is_read %}Box-row--gray{% endif %}" 
                         onclick="markAsRead({{ feed.id }}, event)"
                         data-category="{{ feed.category }}"
                         style="cursor: pointer;">
                        <h3 class="Box-title d-flex flex-items-center">
                            <a href="{{ feed.link }}" 
                               target="_blank" 
                               onclick="event.stopPropagation()"
                               class="flex-auto">
                                {{ feed.title }}
                            </a>
                            <span class="Label Label--secondary ml-2 {% if feed.is_read %}Label--success{% endif %}"
                                  id="status-{{ feed.id }}">
                                {{ 'Read' if feed.is_read else 'Unread' }}
                            </span>
                        </h3>
                        <p class="color-fg-muted">
                            {{ feed.summary }}
                        </p>
                        <div class="d-flex mt-2">
                            <span class="color-fg-muted">
                                {{ feed.pub_date.strftime('%Y-%m-%d %H:%M') }}
                            </span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <script>
    function updateCategoryCount(category, increment) {
        const categoryLink = document.querySelector(`a[href="/?category=${category}"]`);
        if (categoryLink) {
            let counter = categoryLink.querySelector('.Counter');
            if (!counter) {
                counter = document.createElement('span');
                counter.className = 'Counter';
                categoryLink.appendChild(counter);
            }
            
            let count = parseInt(counter.textContent || '0');
            count += increment;
            
            if (count <= 0) {
                counter.remove();
            } else {
                counter.textContent = count;
            }
        }

        // Update "All Categories" counter
        const allCategoriesLink = document.querySelector('a[href="/"]');
        const allCounter = allCategoriesLink.querySelector('.Counter');
        if (allCounter) {
            let totalCount = parseInt(allCounter.textContent || '0');
            totalCount += increment;
            if (totalCount <= 0) {
                allCounter.remove();
            } else {
                allCounter.textContent = totalCount;
            }
        }
    }

    function markAsRead(feedId, event) {
        // Don't toggle if clicking the title link
        if (event.target.tagName === 'A') {
            return;
        }

        const articleElement = event.currentTarget;
        const statusLabel = articleElement.querySelector(`#status-${feedId}`);
        const category = articleElement.dataset.category;
        
        fetch(`/toggle-read/${feedId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (data.is_read) {
                    // Mark as read
                    articleElement.classList.add('Box-row--gray');
                    statusLabel.textContent = 'Read';
                    statusLabel.classList.add('Label--success');
                    updateCategoryCount(category, -1);
                } else {
                    // Mark as unread
                    articleElement.classList.remove('Box-row--gray');
                    statusLabel.textContent = 'Unread';
                    statusLabel.classList.remove('Label--success');
                    updateCategoryCount(category, 1);
                }
            }
        })
        .catch(error => console.error('Error:', error));
    }
    </script>
</body>
</html>
